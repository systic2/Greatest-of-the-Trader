# 주변 경고 UX/시스템 설계 초안

## 설계 목표
- 플레이어가 이동 중에도 전방주시를 유지하도록 보조하고, 위험 상황 감지 시 즉각적으로 인터랙션을 제한한다.
- 경고 체계는 **명확한 상태 구분**과 **반복 피로 최소화**를 지향한다.
- 수집된 텔레메트리는 서버로 전송하여 장기적으로 위험 지역·패턴을 분석한다.

## 상태 모델
| 상태 | 진입 조건 | 허용 행동 | UI/피드백 | 로그 |
| --- | --- | --- | --- | --- |
| `Idle` | 속도 < 0.5 m/s, 기기 각도 0~30°, 위험 구역 반경 밖 | 전체 UI/AR 이용 가능 | 일반 HUD, 경고 없음 | 주기적 keep-alive |
| `Caution` | 0.5 ≤ 속도 < 1.8 m/s(빠른 보행), 기기 각도 30~60° 또는 위험 구역 반경 15m 이내 | 지도 뷰는 허용, AR/NPC 상호작용 버튼 잠시 비활성화 | 상단 옐로우 배너 "잠시 주변을 확인하세요", 짧은 햅틱 1회, 음성 프롬프트 옵션 | 상태 전환 로그 전송 |
| `Danger` | 속도 ≥ 1.8 m/s(러닝/차량 추정) 또는 기기 각도 > 60°(하늘/바닥 응시) ≥ 2초, 위험 구역 반경 5m 이내 | 모든 인터랙션 잠금, 지도 줌 제한, 음성 안내만 유지 | 풀 스크린 세이프티 커튼, 지속적 햅틱(0.5초 on/off), 음성 "기기를 내려 주변을 확인하세요" | 경고 이벤트 + 위치/속도 텔레메트리 |
| `Override` | Danger 상태에서 10초 이상 지속/반복, 플레이어 수동 해제 요청 | 30초간 완전 잠금, "안전 확인" 버튼 후만 해제 | 붉은 배경, 카운트다운 UI | 긴급 로그, 계정 리스크 마킹 |

## 센서·데이터 사용
- **속도**: GPS 및 보조로 IMU 기반 Step Detector 활용. 3초 이동 평균으로 스파이크 완화.
- **기기 각도**: 자이로/가속도 기반으로 device tilt 계산. 손목 회전 보정 필터 적용.
- **위험 구역 데이터**: 지도 팀에서 제공하는 GeoJSON(도로, 횡단보도, 차량 통행량 높은 구역 등)을 로컬 캐시 후 30m 반경 내 proximity 체크.
- **추가 감지(후속)**: 카메라 전방 객체 감지(차량/자전거), 마이크 기반 경적 탐지. MVP 이후 옵션으로 분리.

## UX 플로우
1. **탐험 모드 진입** → 초기 상태 `Idle`.
2. 이동 속도가 기준 이상 상승 시 `Caution` 진입, UI 상단 배너 노출.
3. 속도·각도 개선 후 2초 유지 시 `Idle`로 복귀. 5초 내 재진입 시 배너 음량 증가.
4. 속도 급상승/위험 구역 접근 시 `Danger` 상태 전환 → 세이프티 커튼 + 인터랙션 잠금.
5. Danger 상태에서 플레이어가 걸음을 멈추고 기기를 수평(각도 < 30°)로 유지하면 3초 후 `Caution` → `Idle` 순으로 복귀.
6. Danger 10초 이상 지속 또는 3회/분 발생 시 `Override` 발동. "안전 확인" 버튼을 3초 길게 눌러야 해제가 가능하며, 서버에 리스크 지표 전송.

## 피드백 설계
- **시각**: HUD 컬러 코딩(Idle: 기본, Caution: 노랑, Danger: 적색 커튼). 텍스트는 2줄 이내, 큰 폰트 유지.
- **청각**: TTS 음성 한국어/영어 지원. Caution는 1회, Danger는 5초 간격 반복. 사용자 설정에서 음성/햅틱 on/off 개별 제어.
- **햅틱**: iOS/Android 기본 강도 사용. 장시간 연속 진동 방지를 위해 60초 Danger 유지 시 자동 강도 감소.

### 구현 메모
- `Assets/Scripts/Safety/SafetyStateController.cs`가 Idle→Caution→Danger→Override 상태 머신을 구현하며 속도(위치 서비스), 기기 기울기(자이로), 위험 구역 근접값(`SafetyZoneSensor`)을 평가합니다.
- `SafetyStateUIBinder`를 같은 GameObject에 붙여 HUD/배너/커튼/잠금 UI 오브젝트를 상태에 맞춰 토글합니다.
- 지도 팀은 `SafetyZoneSensor.UpdateProximity()`를 호출해 가장 가까운 위험 구역·세이프존 거리를 매 프레임 주입하면 됩니다.
- `SafetyMapData` ScriptableObject와 `SafetyProximityUpdater`를 사용하면, 미리 정의한 POI(위험/세이프존) 리스트로부터 플레이어의 현재 GPS 좌표를 평가해 `SafetyZoneSensor`에 자동으로 거리를 전달할 수 있습니다.
- 서버 연동을 위해 `SafetyStateController.onMetricsUpdated` 이벤트 훅을 이용, 현재 상태와 측정값을 텔레메트리 모듈에서 수집하도록 합니다.
- `SafetyTelemetryReporter` + `SafetyTelemetrySink` 조합으로 상태 전환/메트릭을 30초 윈도 단위로 집계해 서버 전송할 수 있습니다. 기본 제공 싱크:
  - `ConsoleSafetyTelemetrySink`: 개발 중 콘솔 출력용.
  - `SafetyHttpTelemetrySink`: REST 엔드포인트와 API 키를 설정해 실 서버로 POST 전송.

## 텔레메트리 & 서버 연계
- 이벤트 스키마: `{playerId, stateFrom, stateTo, speedAvg, tiltAvg, gps, timestamp, poiId(optional)}`.
- Danger/Override 발생 시 즉시 전송, Idle↔Caution 전환은 배치 업로드(30초 간격)로 배터리 절약.
- 서버는 반복 Danger 패턴을 학습해 플레이어별 위험 점수 계산 → 일정 이상 시 추가 보호 정책(플레이 제한, 푸시 알림).

## 엣지 케이스
- **승차 시**: 차량 탐지(속도 ≥ 6 m/s) 10초 지속이면 세션 자동 일시정지, UI에 "차량 이동 감지" 안내.
- **센서 오류**: GPS 수신 불가 시 IMU 기반 추정, 5초 이상 실패하면 `Caution` 상태 유지하며 "GPS 신호 약함" 알림.
- **배터리 세이브 모드**: 사용자 요청 시 경고 민감도 축소(속도 임계 +0.3 m/s), 대신 주기적 음성 리마인드 유지.

## 차후 개선 사항
- 머신러닝 기반 위험 예측 모델(센서 융합, 환경 데이터).
- 사용자 위험 행동 리포트 카드 및 교육형 튜토리얼.
- 커뮤니티 신고와 연계한 동적 위험 구역 업데이트.
